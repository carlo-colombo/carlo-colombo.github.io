<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Tag: macro
  
</title>

<meta property="og:type" content="website">
<meta property="og:title" content="litblog">
<meta property="og:url" content="https://carlo-colombo.github.io/tags/macro/index.html">
<meta property="og:site_name" content="litblog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Carlo Colombo">
<meta name="twitter:card" content="summary">


  <link rel="alternative" href="/atom.xml" title="litblog" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">



<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">


<link rel="stylesheet" href="/styles/main.css">



  <!-- Google Analytics -->
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-77255360-1', 'auto');
    ga('send', 'pageview');

  </script>
  <!-- End Google Analytics -->





<meta name="generator" content="Hexo 5.2.0"></head>
<body
  
  >
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">litblog</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">litblog</a></h1>
    
    <div class="info">
      <div class="content">
        
        
          <div class="author">Carlo Colombo</div>
        
      </div>
      
        <div class="avatar">
          
            <img src="https://cn.gravatar.com/avatar/56559186a8e4bb75389af7d997c2f41c?s=200">
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/conform/" rel="tag">conform</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elixir/" rel="tag">elixir</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/exrm/" rel="tag">exrm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcp/" rel="tag">gcp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google-analytics/" rel="tag">google analytics</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google-cloud-functions/" rel="tag">google cloud functions</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k3s/" rel="tag">k3s</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/macro/" rel="tag">macro</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/serverless/" rel="tag">serverless</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/telegram/" rel="tag">telegram</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tiddlywiki/" rel="tag">tiddlywiki</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vps/" rel="tag">vps</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage" external="false">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/about" title="About" external="false">About</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year" external="false">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/carlo-colombo" title="Github" target="_blank" rel="noopener">Github</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS" external="false">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          <h1>macro</h1>


  
  
    <div class="post-list">
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2017/06/10/Track-functions-call-in-Elixir-applications-with-Google-Analytics/" >
  Decorate functions using macros in Elixir
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2017/06/10/Track-functions-call-in-Elixir-applications-with-Google-Analytics/"><span class="article-date">
  2017-06-10
</span>
</a>
        

        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/google-analytics/" rel="tag">google analytics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/macro/" rel="tag">macro</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <p>After I decided to make public a telegram bot to monitor bus time in Dublin (<a href="https://telegram.me/dublin_bus_bot" target="_blank" rel="noopener">@dublin_bus_bot</a>). Before the release I became curious to see how many people will use it (spoiler: just an handful) and I thought that would be a good idea to track the use on google analytics.</p>
<h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>Google analytics provide a measurement protocol that can be used to track things that are different from websites (mobile apps, IOT). At the moment no elixir client exists for this protocol (and it would not be anything more than an api wrapper). My plan is to make call to the Google Analytics TK endpoint with <a href="https://github.com/edgurgel/httpoison" target="_blank" rel="noopener">HTTPOison</a> but Iâ€™d prefer to not have to call the tracking function for every single bot command.</p>
<p>One of the feature that I prefer of the elixir are macros, macros allow to generate code at compile time. I decided to define a macro that looking like a function definition would define a function with the same body and with an additional call to the track function. I decided this approach because seems more idiomatics than using the <a href="https://github.com/arjan/decorator" target="_blank" rel="noopener">decorator syntax</a> typical of other languages (<code>@decorator</code> at least in python and javascript).</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">defmetered sample_function(arg1, arg2) <span class="keyword">do</span></span><br><span class="line">    IO.inspect([arg1, arg2])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># would generate something similar to</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sample_function</span></span>(arg1, arg2) <span class="keyword">do</span></span><br><span class="line">    track(<span class="symbol">:sample_function</span>, [<span class="symbol">arg1:</span> arg1, <span class="symbol">arg2:</span> arg2])</span><br><span class="line">    IO.inspect([arg1, arg2])</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h3><p>I implemented this approach in <a href="https://hex.pm/packages/meter" target="_blank" rel="noopener">meter</a> to use in the telegram bot I wrote.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@doc</span> <span class="string">"""</span></span><br><span class="line"><span class="string">Replace a function definition, automatically tracking every call to the function</span></span><br><span class="line"><span class="string">on google analytics. It also track exception with the function track_error.</span></span><br><span class="line"><span class="string">This macro intended use is with a set of uniform functions that can be concettualy</span></span><br><span class="line"><span class="string">mapped to pageviews (eg: messaging bot commands).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    defmetered function(arg1, arg2), do: IO.inspect(&#123;arg1,arg2&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    function(1,2)</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">will call track with this parameters</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    track(:function, [arg1: 1, arg2: 2])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Additional parameters will be loaded from the configurationd</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="comment"># A macro definition can use pattern matching to destructure the arguments</span></span><br><span class="line"><span class="function"><span class="keyword">defmacro</span> <span class="title">defmetered</span></span>(&#123;function,_,args&#125; = fundef, [<span class="symbol">do:</span> body]) <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># arguments are defined in 3 elements tuples</span></span><br><span class="line">  <span class="comment"># this extract the arguments names in a list</span></span><br><span class="line">  names = Enum.map(args, &amp;elem(&amp;<span class="number">1</span>, 0))</span><br><span class="line"></span><br><span class="line">  <span class="comment"># meter will contain the body of the function that will be defined by the macro</span></span><br><span class="line">  metered = <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># quote and unquote allow to switch context,</span></span><br><span class="line">    <span class="comment"># simplyfing a lot quoted code will run when the function is called</span></span><br><span class="line">    <span class="comment"># unquoted code run at compile time (when the macro is called)</span></span><br><span class="line">    values = unquote(</span><br><span class="line">      args</span><br><span class="line">      |&gt; Enum.map(<span class="keyword">fn</span> arg -&gt;  <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">          <span class="comment"># allow to access a value at runtime knowing the name</span></span><br><span class="line">          <span class="comment"># elixir macros are hygienic so it's necessary to mark it</span></span><br><span class="line">          <span class="comment"># explicitly</span></span><br><span class="line">          var!(unquote(arg))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Match argument names with their own values at call time</span></span><br><span class="line">    map = Enum.zip(unquote(names), values)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># wrap the original function call with a try to track errors too</span></span><br><span class="line">    try <span class="keyword">do</span></span><br><span class="line">      to_return = unquote(body)</span><br><span class="line">      track(unquote(function), map)</span><br><span class="line">      to_return</span><br><span class="line">    rescue</span><br><span class="line">      e -&gt;</span><br><span class="line">        track_error(unquote(function), map, e)</span><br><span class="line">        raise e</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># define a function with the same name and arguments and with the augmented body</span></span><br><span class="line">  <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span>(<span class="title">unquote</span></span>(fundef),unquote([<span class="symbol">do:</span> metered]))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h3><p>Elixir macros are a powerful tool to abstract away some functionality or to write DSLs. They require a bit of time to wrap head around, in particular with the context swith, but it totally worth the hassle if you can reduce the clutter in your code base.</p>

        
      </div>
    </div>

  
    </div>
  






          <div class="main-footer">
  
    Carlo Colombo Â© 2017
  
</div>

      
        </div>
      
    </div>
  </div>
  
<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>


  
<link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">

  
<link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">


  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  
<script src="/PhotoSwipe/photoswipe.js"></script>

  
<script src="/PhotoSwipe/photoswipe-ui-default.js"></script>




<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>


<script src="/scripts/main.js"></script>


</body>
</html>
