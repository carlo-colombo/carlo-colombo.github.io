<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Using Docker Cloud on Scaleway vps | litblog</title><meta property="og:title" content="Using Docker Cloud on Scaleway vps - litblog"><meta property="og:description" content="Docker cloud Docker Cloud (formerly Tutum) help to deploy containers image on node clusters. Nodes can be provisioned directly from the service (Digital Ocean, Azure, AWS, Packet.net, and IBM SoftLayer). Additionally is possible to use the function Bring your own node (BYON) to add any linux server connected to the internet as node and deploy on it.
I&rsquo;m using this service to manage a stack (a set of images described by a file similar to docker-compose."><meta property="og:url" content="http://example.org/posts/using-docker-cloud-on-scaleway-vps/"><meta property="og:site_name" content="litblog"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="docker"><meta property="article:tag" content="vps"><meta property="article:published_time" content="2016-05-14T11:54:31Z"><meta property="article:modified_time" content="2016-05-14T11:54:31Z"><meta name=twitter:card content="summary"><meta name=twitter:site content="@"><meta name=twitter:creator content="@"><link rel=stylesheet href=/css/style.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://example.org/posts/using-docker-cloud-on-scaleway-vps/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=http://example.org/><h1 id=nav-heading class="title is-4">litblog</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/carlo-colombo target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/carlocolombo target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922h-4.388022v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a></nav></div></nav><nav class=nav><div class=nav-left><a class=nav-item href=/about><h2 class="title is-5">About me</h2></a></div></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/docker/>#docker</a>
| <a class="subtitle is-6" href=/tags/vps/>#vps</a></div><h2 class="subtitle is-6">May 14, 2016</h2><h1 class=title>Using Docker Cloud on Scaleway vps</h1><div class=content><h3 id=docker-cloud>Docker cloud</h3><p><a href=https://cloud.docker.com>Docker Cloud</a> (formerly Tutum) help to deploy containers image on node clusters. Nodes can be provisioned directly from the service (Digital Ocean, Azure, AWS, Packet.net, and IBM SoftLayer). Additionally is possible to use the function <em>Bring your own node</em> (BYON) to add any linux server connected to the internet as node and deploy on it.</p><p>I&rsquo;m using this service to manage a stack (a set of images described by a file similar to docker-compose.yml) composed of a static webiste served by nginx, two api server built with elixir, <a href=https://github.com/jwilder/nginx-proxy>nginx-proxy</a> (for reverse proxing) and <a href=https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion>jrcs/letsencrypt-nginx-proxy-companion</a> (create/renewal of Let&rsquo;s Encrypt certificates automatically). Dcoker cloud provide with an interface to start/stop containers and scale up the same image to multiple nodes.</p><p>BYON requires some manual intervention, installing an agent and usually open a port (2375) in to the server firewall to let docker cloud communicate with the agent - additional ports are required to allow network overlay.</p><figure><img src=/images/docker-cloud-byon.png><figcaption><h4>Install the agent</h4></figcaption></figure><h3 id=scaleway>Scaleway</h3><p><a href=https://www.scaleway.com/>Scaleway</a> is a cloud provider still in beta that offer the smaller server (VC1S - 2 x86 64bit Cores, 2GB memory - 50GB SSD Disk - 200Mbit/s badnwidth) for the price of 2.99 â‚¬/month. You can request an invite to the beta at <a href=https://www.scaleway.com/invite/>https://www.scaleway.com/invite/</a></p><p>To open the port requested by the agent to communicate with docker cloud you need to go to security, pick one of the security group and open the necessary port as shown below. A security group is a set of firewall rules that could be applied to multiple servers.</p><figure><img src=/images/scaleway-ports.png><figcaption><h4>Open the port on Scaleway</h4></figcaption></figure><h3 id=installing-the-agent>Installing the agent</h3><p>I set up an ubuntu image (14.04) on the server run the command shown in the BYON pop-up on the server, the agent download and install docker and a few service images. After the installation complete it should connect to the Docker Cloud server and update the pop-up with a success message. Taking some times to connect I checked the log of the agent <code>/var/log/dockercloud/agent.log</code> and saw the following error.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>time=&#34;2016-05-13T21:51:46.196955038Z&#34; level=error msg=&#34;There are no more loopback devices available.&#34;
time=&#34;2016-05-13T21:51:46.197040334Z&#34; level=error msg=&#34;[graphdriver] prior storage driver \&#34;devicemapper\&#34; failed: loopback mounting failed&#34;
time=&#34;2016-05-13T21:51:46.197121360Z&#34; level=fatal msg=&#34;Error starting daemon: error initializing graphdriver: loopback mounting failed&#34;
</code></pre></div><p>To solve this issue is possible is necessary to create some loopback devices, once done the agent start docker and notify Docker Cloud that is ready. Once done is possible to start containers on the newly provided node.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#66d9ef>for</span> i in <span style=color:#66d9ef>$(</span>seq <span style=color:#ae81ff>0</span> 255<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
  mknod -m0660 /dev/loop$i b <span style=color:#ae81ff>7</span> $i
  chown root.disk /dev/loop$i
<span style=color:#66d9ef>done</span>
</code></pre></div><div class=related></div></div></div></section><script src=/js/copycode.js></script><section class=section><div class="container has-text-centered"><p></p></div></section></body></html>