<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Serverless Telegram Bot on GC Functions | litblog</title><meta property="og:title" content="Serverless Telegram Bot on GC Functions - litblog"><meta property="og:description" content="I played for some time with the idea of having a telegram bot run serverless in the cloud. Obviously the code run on some server but it is not necessary to care to provision, deploy, starting the application, etc. All you care about is your code.
GC Functions can be triggered by Pub/Sub events, buckets events and HTTP invocations. The latter is the one that we are going to provide as webhook to Telegram to be invoked when a message is sent to our bot."><meta property="og:url" content="https://carlo-colombo.github.io/posts/serverless-telegram-bot-on-gc-functions/"><meta property="og:site_name" content="litblog"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="telegram"><meta property="article:tag" content="gcp"><meta property="article:tag" content="serverless"><meta property="article:tag" content="google cloud functions"><meta property="article:published_time" content="2017-06-05T09:10:30Z"><meta property="article:modified_time" content="2017-06-05T09:10:30Z"><meta name=twitter:card content="summary"><meta name=twitter:site content="@"><meta name=twitter:creator content="@"><link rel=stylesheet href=/css/style.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://carlo-colombo.github.io/posts/serverless-telegram-bot-on-gc-functions/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://carlo-colombo.github.io/><h1 id=nav-heading class="title is-4">litblog</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/carlo-colombo target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/carlocolombo target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922h-4.388022v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a></nav></div></nav><nav class=nav><div class=nav-left><a class=nav-item href=/about><h2 class="title is-5">About me</h2></a></div></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/telegram/>#telegram</a>
| <a class="subtitle is-6" href=/tags/gcp/>#gcp</a>
| <a class="subtitle is-6" href=/tags/serverless/>#serverless</a>
| <a class="subtitle is-6" href=/tags/google-cloud-functions/>#google cloud functions</a></div><h2 class="subtitle is-6">June 5, 2017</h2><h1 class=title>Serverless Telegram Bot on GC Functions</h1><div class=content><p>I played for some time with the idea of having a telegram bot run <em>serverless</em> in the cloud. Obviously the code run on some server but it is not necessary to care to provision, deploy, starting the application, etc. All you care about is <strong>your code</strong>.</p><p>GC Functions can be triggered by <strong>Pub/Sub</strong> events, <strong>buckets</strong> events and <strong>HTTP</strong> invocations. The latter is the one that we are going to provide as webhook to Telegram to be invoked when a message is sent to our bot.</p><p>Functions are going to remove some friction from our code, when the request is set with the appropriate <code>application/json</code> header the parsed json will be available on the <em>request</em> and when we send back an object is automatically serialized and sent back to the client.</p><p>The example code of the project can be found at <a href=https://github.com/carlo-colombo/serverless-telegram-bot-gc-functions>https://github.com/carlo-colombo/serverless-telegram-bot-gc-functions</a></p><h3 id=prerequisites>Prerequisites</h3><ul><li>Google Cloud account and a project. <a href=https://cloud.google.com/resource-manager/docs/creating-managing-projects>https://cloud.google.com/resource-manager/docs/creating-managing-projects</a></li><li>Enable Google Cloud Functions and RuntimeConfig API from the API manager.</li><li>Get a telegram bot token, ask it to the <a href=https://telegram.me/BotFather>BotFather</a>.</li></ul><h4 id=warning>Warning</h4><ul><li>Both Google Cloud Functions and RuntimeConfig are both still in beta.</li><li>Even if the <a href=https://cloud.google.com/free/>GCP free tier</a> is quite extended some costs can be billed.</li></ul><h3 id=the-token>The token</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># export for local testing </span>
export TELEGRAM_TOKEN<span style=color:#f92672>=</span>133545asdasd

<span style=color:#75715e># set the token as GC runtime configuration </span>
gcloud beta runtime-config configs create prod-config
gcloud beta runtime-config configs variables <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    set telegram/token  <span style=color:#e6db74>&#34;</span>$TELEGRAM_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --config-name prod-config
</code></pre></div><h3 id=the-bot>The bot</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>echoBot</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>){
    <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span>{<span style=color:#a6e22e>chat</span>, <span style=color:#a6e22e>text</span>}} <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>echo</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`echo: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>text</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>

    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>getToken</span>()
        .<span style=color:#a6e22e>then</span>( <span style=color:#a6e22e>token</span> =&gt; <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>post</span>({
            <span style=color:#a6e22e>uri</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`https://api.telegram.org/bot</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/sendMessage`</span>,
            <span style=color:#a6e22e>json</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
            <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> {<span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>echo</span>, <span style=color:#a6e22e>chat_id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>chat</span>.<span style=color:#a6e22e>id</span>}
        }))
        .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>resp</span> =&gt; <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>resp</span>))
        .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span> =&gt; <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>err</span>))
}

</code></pre></div><p>Just an easy bot that echos the received message.</p><h3 id=retrieving-the-token>Retrieving the token</h3><p>This function return a (promise) of a token either from the runtime config api when run online or from an environment variable when run locally. The value is retrieved using <a href=https://github.com/fredriks/cloud-functions-runtime-config>fredriks/cloud-functions-runtime-config</a> that wraps the api. <code>NODE_ENV</code> is set to production when the function is run online, thus allowing to discriminate in which environment the function run.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getToken</span>(){
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>NODE_ENV</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;production&#39;</span>){
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;cloud-functions-runtime-config&#39;</span>)
            .<span style=color:#a6e22e>getVariable</span>(<span style=color:#e6db74>&#39;prod-config&#39;</span>, <span style=color:#e6db74>&#39;telegram/token&#39;</span>)
    }
    <span style=color:#66d9ef>return</span> Promise.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>TELEGRAM_TOKEN</span>)
}
</code></pre></div><h3 id=local-testing>Local testing</h3><p>Google provide a local emulator for Functions feature. It allow to local deploy a function to iterate over it without having to deploy to the google server. It reload the code when changed on the file system so it is not necessary to redeploy after the first time.</p><pre><code>npm -g install @google-cloud/functions-emulator

functions start
functions deploy echoBot --trigger-http

curl -X POST \
  -H &quot;Content-Type: application/json&quot; \
  -d '{
     &quot;message&quot;: {
       &quot;chat&quot;: {
         &quot;id&quot;: 1232456
       },
       &quot;text&quot;: &quot;hello world&quot;
     }
   }' \
   http://localhost:8010/PROJECT_ID/us-central1/echoBot

# To tail logs
watch functions logs read

</code></pre><h3 id=deploying>Deploying</h3><p>Before deploy the function is required to create a Cloud Storage bucket where the function will be stored</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>gsutil mb -c regional -l us-central1 gs://unique-bucket-name

gcloud beta functions deploy function_name <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --trigger-http <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --entry-point echoBot <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --stage-bucket unique-bucket-name
</code></pre></div><h3 id=set-up-the-webhook>Set up the webhook</h3><p>Deploying the function with the http trigger will return an url to trigger the function. The url would look like <code>https://&lt;GCP_REGION>-&lt;PROJECT_ID>.cloudfunctions.net/function_name</code>. Use this url to set up a web hook for your bot on telegram. You can check more information on webhook on the <a href=https://core.telegram.org/bots/api#setwebhook>Telegram API documentation</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>curl -X POST <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -d <span style=color:#e6db74>&#39;{
</span><span style=color:#e6db74>     &#34;url&#34;: &#34;https://&lt;GCP_REGION&gt;-&lt;PROJECT_ID&gt;.cloudfunctions.net/function_name&#34;
</span><span style=color:#e6db74>   }&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   https://api.telegram.org/bot<span style=color:#e6db74>${</span>TELEGRAM_TOKEN<span style=color:#e6db74>}</span>/setWebhook
</code></pre></div><h3 id=conclusions>Conclusions</h3><p>Setting up a Telegram bot using Google Cloud Functions is quick and easy, and with the HTTP trigger is possible to seamlessy set a webhook endpoint for a bot without having to care about a server and https certificates (http trigger are https).</p><p>One last thing to keep in mind is that Functions are stateless and require to be connected to other services to store data or be for example scheduled.</p><div class=related></div></div></div></section><script src=/js/copycode.js></script><section class=section><div class="container has-text-centered"><p>&copy; <a href=https://github.com/carlo-colombo>Carlo Colombo</a> 2021</p></div></section></body></html>