<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>The 3 E: Elixir, Exrm, and Environment variables | litblog</title><meta property="og:title" content="The 3 E: Elixir, Exrm, and Environment variables - litblog"><meta property="og:description" content="Intro I’m building a bot for Telegram, once make a build with exrm I found myself some problem configuring the telegram api key using environment variables. I decided to share what I found because my google foo was not helpful at all.
TL;DR To configure en elixir application built with exrm use conform and load the environment variable in the trasforms section of the conform schema.
config.exs config.exs is where the configuration of elixir project are added."><meta property="og:url" content="https://carlo-colombo.github.io/post/the-3-e-elixir-exrm-and-environment-variables/"><meta property="og:site_name" content="litblog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="elixir"><meta property="article:tag" content="conform"><meta property="article:tag" content="exrm"><meta property="article:published_time" content="2016-05-04T21:05:43Z"><meta property="article:modified_time" content="2016-05-04T21:05:43Z"><meta name=twitter:card content="summary"><meta name=twitter:site content="@"><meta name=twitter:creator content="@"><link rel=stylesheet href=/css/style.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://carlo-colombo.github.io/post/the-3-e-elixir-exrm-and-environment-variables/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://carlo-colombo.github.io/><h1 id=nav-heading class="title is-4">litblog</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/carlo-colombo target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/carlocolombo target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922h-4.388022v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a></nav></div></nav><nav class=nav><div class=nav-left><a class=nav-item href=/about><h2 class="title is-5">About me</h2></a></div></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/elixir/>#elixir</a>
| <a class="subtitle is-6" href=/tags/conform/>#conform</a>
| <a class="subtitle is-6" href=/tags/exrm/>#exrm</a></div><h2 class="subtitle is-6">May 4, 2016</h2><h1 class=title>The 3 E: Elixir, Exrm, and Environment variables</h1><div class=content><h3 id=intro>Intro</h3><p>I’m building a bot for Telegram, once make a build with exrm I found myself some problem configuring the telegram api key using environment variables. I decided to share what I found because my google foo was not helpful at all.</p><h3 id=tldr>TL;DR</h3><p>To configure en elixir application built with <a href=https://github.com/bitwalker/exrm>exrm</a> use <a href=https://github.com/bitwalker/conform>conform</a> and load the environment variable in the trasforms section of the conform schema.</p><h2 id=configexs>config.exs</h2><p>config.exs is where the configuration of elixir project are added. The file is interpreted when a project is ran with <code>ies -S mix</code> or <code>mix run</code>.</p><p>The values are retrieved during the lifetime of the application with the functions(<a href=http://elixir-lang.org/docs/stable/elixir/Application.html#get_env/3>get_env/3</a>, <a href=http://elixir-lang.org/docs/stable/elixir/Application.html#fetch_env/2>fetch_env/2</a>, <a href=http://elixir-lang.org/docs/stable/elixir/Application.html#fetch_env!/2>fetch_env!/2</a>) available in the module Application. To include values from the environment where the project is running <a href=http://elixir-lang.org/docs/stable/elixir/System#get_env/1>System.get_env/1</a> is used.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#f92672>use</span> <span style=color:#a6e22e>Mix.Config</span>

config <span style=color:#e6db74>:plug</span>,
  <span style=color:#e6db74>key1</span>: <span style=color:#e6db74>&#34;value1&#34;</span>,
  <span style=color:#e6db74>key2</span>: <span style=color:#a6e22e>System</span><span style=color:#f92672>.</span>get_env(<span style=color:#e6db74>&#34;KEY&#34;</span>)

import_config <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span><span style=color:#a6e22e>Mix</span><span style=color:#f92672>.</span>env<span style=color:#e6db74>}</span><span style=color:#e6db74>.exs&#34;</span>
</code></pre></div><h2 id=exrm>exrm</h2><p>Surprisingly (if you did not have an erlang background as me) when you make a release of your project with exrm the <code>config.exs</code> file is executed at build time and the environment variables are crystallized in the build output.</p><p>The output from exrm contains a file named <code>sys.config</code> that is the output of executing the <code>config.exs</code> file and is defined as erlang terms. Once released editing this file is the only way to dynamically configure the application once built.</p><h2 id=conform>conform</h2><p><a href=https://github.com/bitwalker/conform>conform</a> is a library from the same author of exrm and is been made to ease the configuration of elixir application. The library validate a property like file (<code>configuration/your_app.conf</code>) against a configuration schema (<code>configuration/your_app.schema.exs</code>) and generate the <code>sys.config</code> file. The schema file contains descriptions, defaults, and types of the parameters. A property file is a lot easier and common to configure than a file containing erlang terms, additionaly conform add flexibility and more control over configurations.</p><p>A couple of task are made available to transition to a conform based configuration.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#75715e>#generate the schema from the actual configuration</span>
mix conform<span style=color:#f92672>.</span>new

<span style=color:#75715e>#generate a .conf file from the configuration</span>
mix conform<span style=color:#f92672>.</span>configure
</code></pre></div><p>The <code>sys.config</code> is generated at the start of the application, and using the plugin <code>exrm_conform</code> at the start of a packaged application. This behaviour allow to load configuration parameter from environment variables defined when the application is started.</p><p>After running <code>mix conform.new</code> you will find a <code>yourapp.schema.exs</code> in your <code>conf</code> folder, this file has 3 main sections: mapping, transforms, and validators. The mapping section is where the parameters are defined and where you can set up defaults, descriptions, and type. The transform section allow to add transformation function to change or derive a configured parameter. In the end the validators sections allow to reject invalid configuration errors and stop the application.</p><p>At first I tried to add the reading from the environment variable to the default of the parameters, but this lend to an uncommon situation where a static parameter (the one in <code>yourapp.conf</code>) will override a parameter derived from an environment variable.</p><p>Eventually I found that adding a function to transforms is probably a better way to do it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>[
  <span style=color:#e6db74>extends</span>: [],
  <span style=color:#e6db74>import</span>: [],
  <span style=color:#e6db74>mappings</span>: [...],
  <span style=color:#e6db74>transforms</span>: [
    <span style=color:#e6db74>&#34;nadia.token&#34;</span>: <span style=color:#66d9ef>fn</span> conf <span style=color:#f92672>-&gt;</span>
      [{_, val}] <span style=color:#f92672>=</span> <span style=color:#a6e22e>Conform.Conf</span><span style=color:#f92672>.</span>get(conf, <span style=color:#e6db74>&#34;nadia.token&#34;</span>)
      <span style=color:#a6e22e>System</span><span style=color:#f92672>.</span>get_env(<span style=color:#e6db74>&#34;TELEGRAM_BOT_TOKEN&#34;</span>) <span style=color:#f92672>||</span> val
    <span style=color:#66d9ef>end</span>],
  <span style=color:#e6db74>validators</span>: []
]
</code></pre></div><p>In this case we are loading with the conform API the the configured value and return it only if the environment variable is empty. Generating the parameter in this way disallow to have a default in the mapping sections but a workaround would be to chain <code>||</code> to add a default value. I think that this approach is not bad for api key and similar values that you don&rsquo;t want to checkin with your code (even if are keys of development environments).</p><div class=related></div></div></div></section><script src=/js/copycode.js></script><section class=section><div class="container has-text-centered"><p>&copy; <a href=https://github.com/carlo-colombo>Carlo Colombo</a> 2021</p></div></section></body></html>