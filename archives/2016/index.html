<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Archive: 2016
  
</title>

<meta property="og:type" content="website">
<meta property="og:title" content="litblog">
<meta property="og:url" content="https://carlo-colombo.github.io/archives/2016/index.html">
<meta property="og:site_name" content="litblog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Carlo Colombo">
<meta name="twitter:card" content="summary">


  <link rel="alternative" href="/atom.xml" title="litblog" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">



<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">


<link rel="stylesheet" href="/styles/main.css">



  <!-- Google Analytics -->
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-77255360-1', 'auto');
    ga('send', 'pageview');

  </script>
  <!-- End Google Analytics -->





<meta name="generator" content="Hexo 5.2.0"></head>
<body
  
  >
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">litblog</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">litblog</a></h1>
    
    <div class="info">
      <div class="content">
        
        
          <div class="author">Carlo Colombo</div>
        
      </div>
      
        <div class="avatar">
          
            <img src="https://cn.gravatar.com/avatar/56559186a8e4bb75389af7d997c2f41c?s=200">
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/conform/" rel="tag">conform</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elixir/" rel="tag">elixir</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/exrm/" rel="tag">exrm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcp/" rel="tag">gcp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google-analytics/" rel="tag">google analytics</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google-cloud-functions/" rel="tag">google cloud functions</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k3s/" rel="tag">k3s</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/macro/" rel="tag">macro</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/serverless/" rel="tag">serverless</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/telegram/" rel="tag">telegram</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tiddlywiki/" rel="tag">tiddlywiki</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vps/" rel="tag">vps</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage" external="false">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/about" title="About" external="false">About</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year" external="false">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/carlo-colombo" title="Github" target="_blank" rel="noopener">Github</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS" external="false">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          

  
  
    
      
      
      <section class="archives-wrap">
        <div class="archive-year-wrap">
          <h1><a href="/archives/2016" class="archive-year">2016</a></h1>
        </div>
        <div class="post-list">
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016/05/14/Using-Docker-Cloud-on-Scaleway-vps/" >
  Using Docker Cloud on Scaleway vps
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016/05/14/Using-Docker-Cloud-on-Scaleway-vps/"><span class="article-date">
  2016-05-14
</span>
</a>
        

        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vps/" rel="tag">vps</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h3 id="Docker-cloud"><a href="#Docker-cloud" class="headerlink" title="Docker cloud"></a>Docker cloud</h3><p><a href="https://cloud.docker.com/" target="_blank" rel="noopener">Docker Cloud</a> (formerly Tutum) help to deploy containers image on node clusters. Nodes can be provisioned directly from the service (Digital Ocean, Azure, AWS, Packet.net, and IBM SoftLayer). Additionally is possible to use the function <em>Bring your own node</em> (BYON)  to add any linux server connected to the internet as node and deploy on it.</p>
<p>I’m using this service to manage a stack (a set of images described by a file similar to docker-compose.yml) composed of a static webiste served by nginx, two api server built with elixir, <a href="https://github.com/jwilder/nginx-proxy" target="_blank" rel="noopener">nginx-proxy</a> (for reverse proxing) and <a href="https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion" target="_blank" rel="noopener">jrcs/letsencrypt-nginx-proxy-companion</a> (create/renewal of Let’s Encrypt certificates automatically). Dcoker cloud provide with an interface to start/stop containers and scale up the same image to multiple nodes.</p>
<p>BYON requires some manual intervention, installing an agent and usually open a port (2375) in to the server firewall to let docker cloud communicate with the agent - additional ports are required to allow network overlay.</p>
<img src="/2016/05/14/Using-Docker-Cloud-on-Scaleway-vps/docker-cloud-byon.png" title="Install the agent">

<h3 id="Scaleway"><a href="#Scaleway" class="headerlink" title="Scaleway"></a>Scaleway</h3><p><a href="https://www.scaleway.com/" target="_blank" rel="noopener">Scaleway</a> is a cloud provider still in beta that offer the smaller server (VC1S - 2 x86 64bit Cores, 2GB memory - 50GB SSD Disk - 200Mbit/s badnwidth) for the price of 2.99 €/month. You can request an invite to the beta at <a href="https://www.scaleway.com/invite/" target="_blank" rel="noopener">https://www.scaleway.com/invite/</a></p>
<p>To open the port requested by the agent to communicate with docker cloud you need to go to security, pick one of the security group and open the necessary port as shown below. A security group is a set of firewall rules that could be applied to multiple servers.</p>
<img src="/2016/05/14/Using-Docker-Cloud-on-Scaleway-vps/scaleway-ports.png" title="Open the port on Scaleway">

<h3 id="Installing-the-agent"><a href="#Installing-the-agent" class="headerlink" title="Installing the agent"></a>Installing the agent</h3><p>I set up an ubuntu image (14.04) on the server run the command shown in the BYON pop-up on the server, the agent download and install docker and a few service images. After the installation complete it should connect to the Docker Cloud server and update the pop-up with a success message. Taking some times to connect I checked the log of the agent <code>/var/log/dockercloud/agent.log</code> and saw the following error.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">time=&quot;2016-05-13T21:51:46.196955038Z&quot; level=error msg=&quot;There are no more loopback devices available.&quot;</span><br><span class="line">time=&quot;2016-05-13T21:51:46.197040334Z&quot; level=error msg=&quot;[graphdriver] prior storage driver \&quot;devicemapper\&quot; failed: loopback mounting failed&quot;</span><br><span class="line">time=&quot;2016-05-13T21:51:46.197121360Z&quot; level=fatal msg=&quot;Error starting daemon: error initializing graphdriver: loopback mounting failed&quot;</span><br></pre></td></tr></table></figure>

<p>To solve this issue is possible is necessary to create some loopback devices, once done the agent start docker and notify Docker Cloud that is ready. Once done is possible to start containers on the newly provided node.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in $(seq 0 255); do</span><br><span class="line">  mknod -m0660 /dev/loop$i b 7 $i</span><br><span class="line">  chown root.disk /dev/loop$i</span><br><span class="line">done</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016/05/04/The-3-E-Elixir-Exrm-and-Environment-Variables/" >
  The 3 E: Elixir, Exrm, and Environment variables
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016/05/04/The-3-E-Elixir-Exrm-and-Environment-Variables/"><span class="article-date">
  2016-05-04
</span>
</a>
        

        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/conform/" rel="tag">conform</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/exrm/" rel="tag">exrm</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h3 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h3><p>I’m building a bot for Telegram, once make a build with exrm I found myself some problem configuring the telegram api key using environment variables. I decided to share what I found because my google foo was not helpful at all.</p>
<h3 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h3><p>To configure en elixir application built with <a href="https://github.com/bitwalker/exrm" target="_blank" rel="noopener">exrm</a> use <a href="https://github.com/bitwalker/conform" target="_blank" rel="noopener">conform</a> and load the environment variable in the trasforms section of the conform schema.</p>
<h2 id="config-exs"><a href="#config-exs" class="headerlink" title="config.exs"></a>config.exs</h2><p>config.exs is where the configuration of elixir project are added. The file is interpreted when a project is ran with <code>ies -S mix</code> or <code>mix run</code>.</p>
<p>The values are retrieved during the lifetime of the application with the functions(<a href="http://elixir-lang.org/docs/stable/elixir/Application.html#get_env/3" target="_blank" rel="noopener">get_env/3</a>, <a href="http://elixir-lang.org/docs/stable/elixir/Application.html#fetch_env/2" target="_blank" rel="noopener">fetch_env/2</a>, <a href="http://elixir-lang.org/docs/stable/elixir/Application.html#fetch_env!/2" target="_blank" rel="noopener">fetch_env!/2</a>) available in the module Application. To include values from the environment where the project is running <a href="http://elixir-lang.org/docs/stable/elixir/System#get_env/1" target="_blank" rel="noopener">System.get_env/1</a> is used.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> Mix.Config</span><br><span class="line"></span><br><span class="line">config <span class="symbol">:plug</span>,</span><br><span class="line">  <span class="symbol">key1:</span> <span class="string">"value1"</span>,</span><br><span class="line">  <span class="symbol">key2:</span> System.get_env(<span class="string">"KEY"</span>)</span><br><span class="line"></span><br><span class="line">import_config <span class="string">"<span class="subst">#&#123;Mix.env&#125;</span>.exs"</span></span><br></pre></td></tr></table></figure>

<h2 id="exrm"><a href="#exrm" class="headerlink" title="exrm"></a>exrm</h2><p>Surprisingly (if you did not have an erlang background as me) when you make a release of your project with exrm the <code>config.exs</code> file is executed at build time and the environment variables are crystallized in the build output.</p>
<p>The output from exrm contains a file named <code>sys.config</code> that is the output of executing the <code>config.exs</code> file and is defined as erlang terms. Once released editing this file is the only way to dynamically configure the application once built.</p>
<h2 id="conform"><a href="#conform" class="headerlink" title="conform"></a>conform</h2><p><a href="https://github.com/bitwalker/conform" target="_blank" rel="noopener">conform</a> is a library from the same author of exrm and is been made to ease the configuration of elixir application. The library validate a property like file (<code>configuration/your_app.conf</code>) against a configuration schema (<code>configuration/your_app.schema.exs</code>) and generate the <code>sys.config</code> file. The schema file contains descriptions, defaults, and types of the parameters. A property file is a lot easier and common to configure than a file containing erlang terms, additionaly conform add flexibility and more control over configurations.</p>
<p>A couple of task are made available to transition to a conform based configuration.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#generate the schema from the actual configuration</span></span><br><span class="line">mix conform.new</span><br><span class="line"></span><br><span class="line"><span class="comment">#generate a .conf file from the configuration</span></span><br><span class="line">mix conform.configure</span><br></pre></td></tr></table></figure>

<p>The <code>sys.config</code> is generated at the start of the application, and using the plugin <code>exrm_conform</code> at the start of a packaged application. This behaviour allow to load configuration parameter from environment variables defined when the application is started.</p>
<p>After running <code>mix conform.new</code> you will find a <code>yourapp.schema.exs</code> in your <code>conf</code> folder, this file has 3 main sections: mapping, transforms, and validators. The mapping section is where the parameters are defined and where you can set up defaults, descriptions, and type. The transform section allow to add transformation function to change or derive a configured parameter. In the end the validators sections allow to reject invalid configuration errors and stop the application.</p>
<p>At first I tried to add the reading from the environment variable to the default of the parameters, but this lend to an uncommon situation where a static parameter (the one in <code>yourapp.conf</code>) will override a parameter derived from an environment variable.</p>
<p>Eventually I found that adding a function to transforms is probably a better way to do it.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  <span class="symbol">extends:</span> [],</span><br><span class="line">  <span class="symbol">import:</span> [],</span><br><span class="line">  <span class="symbol">mappings:</span> [...],</span><br><span class="line">  <span class="symbol">transforms:</span> [</span><br><span class="line">    <span class="string">"nadia.token"</span>: <span class="keyword">fn</span> conf -&gt;</span><br><span class="line">      [&#123;_, val&#125;] = Conform.Conf.get(conf, <span class="string">"nadia.token"</span>)</span><br><span class="line">      System.get_env(<span class="string">"TELEGRAM_BOT_TOKEN"</span>) || val</span><br><span class="line">    <span class="keyword">end</span>],</span><br><span class="line">  <span class="symbol">validators:</span> []</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>In this case we are loading with the conform API the the configured value and return it only if the environment variable is empty. Generating the parameter in this way disallow to have a default in the mapping sections but a workaround would be to chain <code>||</code> to add a default value. I think that this approach is not bad for api key and similar values that you don’t want to checkin with your code (even if are keys of development environments).</p>

        
      </div>
    </div>

  






          <div class="main-footer">
  
    Carlo Colombo © 2017
  
</div>

      
        </div>
      
    </div>
  </div>
  
<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>


  
<link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">

  
<link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">


  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  
<script src="/PhotoSwipe/photoswipe.js"></script>

  
<script src="/PhotoSwipe/photoswipe-ui-default.js"></script>




<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>


<script src="/scripts/main.js"></script>


</body>
</html>
