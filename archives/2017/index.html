<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Archive: 2017
  
</title>

<meta property="og:type" content="website">
<meta property="og:title" content="litblog">
<meta property="og:url" content="https://carlo-colombo.github.io/archives/2017/index.html">
<meta property="og:site_name" content="litblog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Carlo Colombo">
<meta name="twitter:card" content="summary">


  <link rel="alternative" href="/atom.xml" title="litblog" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">



<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">


<link rel="stylesheet" href="/styles/main.css">



<meta name="generator" content="Hexo 5.2.0"></head>
<body
  
  >
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">litblog</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">litblog</a></h1>
    
    <div class="info">
      <div class="content">
        
        
          <div class="author">Carlo Colombo</div>
        
      </div>
      
        <div class="avatar">
          
            <img src="https://cn.gravatar.com/avatar/56559186a8e4bb75389af7d997c2f41c?s=200">
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/conform/" rel="tag">conform</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elixir/" rel="tag">elixir</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/exrm/" rel="tag">exrm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcp/" rel="tag">gcp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google-analytics/" rel="tag">google analytics</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google-cloud-functions/" rel="tag">google cloud functions</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k3s/" rel="tag">k3s</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/macro/" rel="tag">macro</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/serverless/" rel="tag">serverless</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/telegram/" rel="tag">telegram</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tiddlywiki/" rel="tag">tiddlywiki</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vps/" rel="tag">vps</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage" external="false">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/about" title="About" external="false">About</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year" external="false">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/carlo-colombo" title="Github" target="_blank" rel="noopener">Github</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS" external="false">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          

  
  
    
      
      
      <section class="archives-wrap">
        <div class="archive-year-wrap">
          <h1><a href="/archives/2017" class="archive-year">2017</a></h1>
        </div>
        <div class="post-list">
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2017/06/10/Track-functions-call-in-Elixir-applications-with-Google-Analytics/" >
  Decorate functions using macros in Elixir
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2017/06/10/Track-functions-call-in-Elixir-applications-with-Google-Analytics/"><span class="article-date">
  2017-06-10
</span>
</a>
        

        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/google-analytics/" rel="tag">google analytics</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/macro/" rel="tag">macro</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <p>After I decided to make public a telegram bot to monitor bus time in Dublin (<a href="https://telegram.me/dublin_bus_bot" target="_blank" rel="noopener">@dublin_bus_bot</a>). Before the release I became curious to see how many people will use it (spoiler: just an handful) and I thought that would be a good idea to track the use on google analytics.</p>
<h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>Google analytics provide a measurement protocol that can be used to track things that are different from websites (mobile apps, IOT). At the moment no elixir client exists for this protocol (and it would not be anything more than an api wrapper). My plan is to make call to the Google Analytics TK endpoint with <a href="https://github.com/edgurgel/httpoison" target="_blank" rel="noopener">HTTPOison</a> but Iâ€™d prefer to not have to call the tracking function for every single bot command.</p>
<p>One of the feature that I prefer of the elixir are macros, macros allow to generate code at compile time. I decided to define a macro that looking like a function definition would define a function with the same body and with an additional call to the track function. I decided this approach because seems more idiomatics than using the <a href="https://github.com/arjan/decorator" target="_blank" rel="noopener">decorator syntax</a> typical of other languages (<code>@decorator</code> at least in python and javascript).</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">defmetered sample_function(arg1, arg2) <span class="keyword">do</span></span><br><span class="line">    IO.inspect([arg1, arg2])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># would generate something similar to</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sample_function</span></span>(arg1, arg2) <span class="keyword">do</span></span><br><span class="line">    track(<span class="symbol">:sample_function</span>, [<span class="symbol">arg1:</span> arg1, <span class="symbol">arg2:</span> arg2])</span><br><span class="line">    IO.inspect([arg1, arg2])</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h3><p>I implemented this approach in <a href="https://hex.pm/packages/meter" target="_blank" rel="noopener">meter</a> to use in the telegram bot I wrote.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@doc</span> <span class="string">"""</span></span><br><span class="line"><span class="string">Replace a function definition, automatically tracking every call to the function</span></span><br><span class="line"><span class="string">on google analytics. It also track exception with the function track_error.</span></span><br><span class="line"><span class="string">This macro intended use is with a set of uniform functions that can be concettualy</span></span><br><span class="line"><span class="string">mapped to pageviews (eg: messaging bot commands).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    defmetered function(arg1, arg2), do: IO.inspect(&#123;arg1,arg2&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    function(1,2)</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">will call track with this parameters</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    track(:function, [arg1: 1, arg2: 2])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Additional parameters will be loaded from the configurationd</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="comment"># A macro definition can use pattern matching to destructure the arguments</span></span><br><span class="line"><span class="function"><span class="keyword">defmacro</span> <span class="title">defmetered</span></span>(&#123;function,_,args&#125; = fundef, [<span class="symbol">do:</span> body]) <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># arguments are defined in 3 elements tuples</span></span><br><span class="line">  <span class="comment"># this extract the arguments names in a list</span></span><br><span class="line">  names = Enum.map(args, &amp;elem(&amp;<span class="number">1</span>, 0))</span><br><span class="line"></span><br><span class="line">  <span class="comment"># meter will contain the body of the function that will be defined by the macro</span></span><br><span class="line">  metered = <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># quote and unquote allow to switch context,</span></span><br><span class="line">    <span class="comment"># simplyfing a lot quoted code will run when the function is called</span></span><br><span class="line">    <span class="comment"># unquoted code run at compile time (when the macro is called)</span></span><br><span class="line">    values = unquote(</span><br><span class="line">      args</span><br><span class="line">      |&gt; Enum.map(<span class="keyword">fn</span> arg -&gt;  <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">          <span class="comment"># allow to access a value at runtime knowing the name</span></span><br><span class="line">          <span class="comment"># elixir macros are hygienic so it's necessary to mark it</span></span><br><span class="line">          <span class="comment"># explicitly</span></span><br><span class="line">          var!(unquote(arg))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Match argument names with their own values at call time</span></span><br><span class="line">    map = Enum.zip(unquote(names), values)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># wrap the original function call with a try to track errors too</span></span><br><span class="line">    try <span class="keyword">do</span></span><br><span class="line">      to_return = unquote(body)</span><br><span class="line">      track(unquote(function), map)</span><br><span class="line">      to_return</span><br><span class="line">    rescue</span><br><span class="line">      e -&gt;</span><br><span class="line">        track_error(unquote(function), map, e)</span><br><span class="line">        raise e</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># define a function with the same name and arguments and with the augmented body</span></span><br><span class="line">  <span class="keyword">quote</span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span>(<span class="title">unquote</span></span>(fundef),unquote([<span class="symbol">do:</span> metered]))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h3><p>Elixir macros are a powerful tool to abstract away some functionality or to write DSLs. They require a bit of time to wrap head around, in particular with the context swith, but it totally worth the hassle if you can reduce the clutter in your code base.</p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2017/06/05/Serverless-Telegram-Bot-on-GC-functions/" >
  Serverless Telegram Bot on GC Functions
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2017/06/05/Serverless-Telegram-Bot-on-GC-functions/"><span class="article-date">
  2017-06-05
</span>
</a>
        

        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gcp/" rel="tag">gcp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/google-cloud-functions/" rel="tag">google cloud functions</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/serverless/" rel="tag">serverless</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/telegram/" rel="tag">telegram</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <p>I played for some time with the idea of having a telegram bot run <em>serverless</em> in the cloud. Obviously the code run on some server but it is not necessary to care to provision, deploy, starting the application, etc. All you care about is <strong>your code</strong>.</p>
<p>GC Functions can be triggered by <strong>Pub/Sub</strong> events, <strong>buckets</strong> events and <strong>HTTP</strong> invocations. The latter is the one that we are going to provide as webhook to Telegram to be invoked when a message is sent to our bot.</p>
<p>Functions are going to remove some friction from our code, when the request is set with the appropriate <code>application/json</code> header the parsed json will be available on the <em>request</em> and when we send back an object is automatically serialized and sent back to the client. </p>
<p>The example code of the project can be found at <a href="https://github.com/carlo-colombo/serverless-telegram-bot-gc-functions" target="_blank" rel="noopener">https://github.com/carlo-colombo/serverless-telegram-bot-gc-functions</a></p>
<h3 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h3><ul>
<li>Google Cloud account and a project. <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" target="_blank" rel="noopener">https://cloud.google.com/resource-manager/docs/creating-managing-projects</a></li>
<li>Enable Google Cloud Functions and RuntimeConfig API from the API manager.</li>
<li>Get a telegram bot token, ask it to the <a href="https://telegram.me/BotFather" target="_blank" rel="noopener">BotFather</a>.</li>
</ul>
<h4 id="Warning"><a href="#Warning" class="headerlink" title="Warning"></a>Warning</h4><ul>
<li>Both Google Cloud Functions and RuntimeConfig are both still in beta.</li>
<li>Even if the <a href="https://cloud.google.com/free/" target="_blank" rel="noopener">GCP free tier</a> is quite extended some costs can be billed.</li>
</ul>
<h3 id="The-token"><a href="#The-token" class="headerlink" title="The token"></a>The token</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># export for local testing </span></span><br><span class="line"><span class="built_in">export</span> TELEGRAM_TOKEN=133545asdasd</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the token as GC runtime configuration </span></span><br><span class="line">gcloud beta runtime-config configs create prod-config</span><br><span class="line">gcloud beta runtime-config configs variables \</span><br><span class="line">    <span class="built_in">set</span> telegram/token  <span class="string">"<span class="variable">$TELEGRAM_TOKEN</span>"</span> \</span><br><span class="line">    --config-name prod-config</span><br></pre></td></tr></table></figure>

<h3 id="The-bot"><a href="#The-bot" class="headerlink" title="The bot"></a>The bot</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">exports.echoBot = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;<span class="attr">message</span>:&#123;chat, text&#125;&#125; = req.body</span><br><span class="line">    <span class="keyword">const</span> echo = <span class="string">`echo: <span class="subst">$&#123;text&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> getToken()</span><br><span class="line">        .then( <span class="function"><span class="params">token</span> =&gt;</span> request.post(&#123;</span><br><span class="line">            uri: <span class="string">`https://api.telegram.org/bot<span class="subst">$&#123;token&#125;</span>/sendMessage`</span>,</span><br><span class="line">            json: <span class="literal">true</span>,</span><br><span class="line">            body: &#123;<span class="attr">text</span>: echo, <span class="attr">chat_id</span>: chat.id&#125;</span><br><span class="line">        &#125;))</span><br><span class="line">        .then(<span class="function"><span class="params">resp</span> =&gt;</span> res.send(resp))</span><br><span class="line">        .catch(<span class="function"><span class="params">err</span> =&gt;</span> res.status(<span class="number">500</span>).send(err))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Just an easy bot that echos the received message.</p>
<h3 id="Retrieving-the-token"><a href="#Retrieving-the-token" class="headerlink" title="Retrieving the token"></a>Retrieving the token</h3><p>This function return a (promise) of a token either from the runtime config api when run online or from an environment variable when run locally. The value is retrieved using <a href="https://github.com/fredriks/cloud-functions-runtime-config" target="_blank" rel="noopener">fredriks/cloud-functions-runtime-config</a> that wraps the api. <code>NODE_ENV</code> is set to production when the function is run online, thus allowing to discriminate in which environment the function run.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getToken</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV == <span class="string">'production'</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">'cloud-functions-runtime-config'</span>)</span><br><span class="line">            .getVariable(<span class="string">'prod-config'</span>, <span class="string">'telegram/token'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(process.env.TELEGRAM_TOKEN)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Local-testing"><a href="#Local-testing" class="headerlink" title="Local testing"></a>Local testing</h3><p>Google provide a local emulator for Functions feature. It allow to local deploy a function to iterate over it without having to deploy to the google server. It reload the code when changed on the file system so it is not necessary to redeploy after the first time.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">npm -g install @google-cloud/functions-emulator</span><br><span class="line"></span><br><span class="line">functions start</span><br><span class="line">functions deploy echoBot --trigger-http</span><br><span class="line"></span><br><span class="line">curl -X POST \</span><br><span class="line">  -H &quot;Content-Type: application/json&quot; \</span><br><span class="line">  -d &apos;&#123;</span><br><span class="line">     &quot;message&quot;: &#123;</span><br><span class="line">       &quot;chat&quot;: &#123;</span><br><span class="line">         &quot;id&quot;: 1232456</span><br><span class="line">       &#125;,</span><br><span class="line">       &quot;text&quot;: &quot;hello world&quot;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;&apos; \</span><br><span class="line">   http://localhost:8010/PROJECT_ID/us-central1/echoBot</span><br><span class="line"></span><br><span class="line"># To tail logs</span><br><span class="line">watch functions logs read</span><br></pre></td></tr></table></figure>

<h3 id="Deploying"><a href="#Deploying" class="headerlink" title="Deploying"></a>Deploying</h3><p>Before deploy the function is required to create a Cloud Storage bucket where the function will be stored</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gsutil mb -c regional -l us-central1 gs://unique-bucket-name</span><br><span class="line"></span><br><span class="line">gcloud beta <span class="built_in">functions</span> deploy function_name \</span><br><span class="line">  --trigger-http \</span><br><span class="line">  --entry-point echoBot \</span><br><span class="line">  --stage-bucket unique-bucket-name</span><br></pre></td></tr></table></figure>

<h3 id="Set-up-the-webhook"><a href="#Set-up-the-webhook" class="headerlink" title="Set up the webhook"></a>Set up the webhook</h3><p>Deploying the function with the http trigger will return an url to trigger the function. The url would look like <code>https://&lt;GCP_REGION&gt;-&lt;PROJECT_ID&gt;.cloudfunctions.net/function_name</code>. Use this url to set up a web hook for your bot on telegram. You can check more information on webhook on the <a href="https://core.telegram.org/bots/api#setwebhook" target="_blank" rel="noopener">Telegram API documentation</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  -d <span class="string">'&#123;</span></span><br><span class="line"><span class="string">     "url": "https://&lt;GCP_REGION&gt;-&lt;PROJECT_ID&gt;.cloudfunctions.net/function_name"</span></span><br><span class="line"><span class="string">   &#125;'</span> \</span><br><span class="line">   https://api.telegram.org/bot<span class="variable">$&#123;TELEGRAM_TOKEN&#125;</span>/setWebhook</span><br></pre></td></tr></table></figure>

<h3 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h3><p>Setting up a Telegram bot using Google Cloud Functions is quick and easy, and with the HTTP trigger is possible to seamlessy set a webhook endpoint for a bot without having to care about a server and https certificates (http trigger are https).</p>
<p>One last thing to keep in mind is that Functions are stateless and require to be connected to other services to store data or be for example scheduled. </p>

        
      </div>
    </div>

  






          <div class="main-footer">
  
    Carlo Colombo Â© 2017
  
</div>

      
        </div>
      
    </div>
  </div>
  
<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>


  
<link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">

  
<link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">


  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  
<script src="/PhotoSwipe/photoswipe.js"></script>

  
<script src="/PhotoSwipe/photoswipe-ui-default.js"></script>




<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>


<script src="/scripts/main.js"></script>


</body>
</html>
